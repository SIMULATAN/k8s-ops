apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: wakapi

resources:
- postgres-cluster.yml
- wakapi-smtp.yml

helmCharts:
- name: wakapi
  releaseName: wakapi
  repo: https://ricristian.github.io/wakapi-helm-chart/
  valuesFile: wakapi.values.yml
  version: 1.0.22
  skipTests: true

patches:
  - target:
      version: v1
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: WAKAPI_DB_PASSWORD
            valueFrom:
              secretKeyRef:
                key: password
                name: wakapi-postgres-app
          - name: WAKAPI_MAIL_SMTP_PASS
            valueFrom:
              secretKeyRef:
                key: password
                name: wakapi-smtp
