instanceLabelOverride: traefik

deployment:
  kind: DaemonSet

providers:
  kubernetesCRD:
    allowCrossNamespace: true

service:
  externalTrafficPolicy: Local
  ipFamilyPolicy: "PreferDualStack"

priorityClassName: "system-cluster-critical"

tolerations:
  - key: "CriticalAddonsOnly"
    operator: "Exists"
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Exists"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/master"
    operator: "Exists"
    effect: "NoSchedule"

ports:
  web:
    forwardedHeaders:
      trustedIPs: ["10.42.0.0/16"]
  websecure:
    forwardedHeaders:
      trustedIPs: ["10.42.0.0/16"]

metrics:
  prometheus:
    # bugged for some reason
    disableAPICheck: true
    service:
      # create dedicated metrics service
      enabled: true
    serviceMonitor:
      enabled: true
      honorLabels: true
tracing:
  otlp:
    enabled: true
    grpc:
      enabled: true
      endpoint: alloy.monitoring.svc.cluster.local:4317
      insecure: true

experimental:
  plugins:
    traefikoidc:
      moduleName: github.com/lukaszraczylo/traefikoidc
      version: v0.7.0-beta6

ingressRoute:
  api:
    enabled: true
    matchRule: Host(`traefik.simulatan.me`) && PathPrefix(`/api`)
    entryPoints:
      - web
      - websecure
    services:
      - name: api@internal
        kind: TraefikService
    middlewares:
      - name: redirect-to-https
        namespace: default
      - name: forwardauth-authelia
        namespace: auth
  dashboard:
    enabled: true
    matchRule: Host(`traefik.simulatan.me`)
    entryPoints:
      - web
      - websecure
    services:
      - name: api@internal
        kind: TraefikService
    middlewares:
      - name: redirect-to-https
        namespace: default
      - name: strip-traefik-dashboard-prefix
        namespace: traefik
      - name: forwardauth-authelia
        namespace: auth
